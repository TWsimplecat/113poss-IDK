<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>èª²è¡¨ç³»çµ±</title>
    <style>
        body { font-family: sans-serif; }
        .highlight {
            background-color: yellow;
            font-weight: bold;
            box-shadow: 0 0 5px #999;
        }
    </style>
</head>
<body>
    <h1>æˆ‘çš„èª²è¡¨</h1>

    <p id="current-time" style="font-size: 1.2em; font-weight: bold; color: #333;">
        ç¾åœ¨æ™‚é–“ï¼šè¼‰å…¥ä¸­...
    </p>

    <h2>ğŸ“ ä¸Šå‚³èª²è¡¨ CSV</h2>
    <form method="POST" action="/upload" enctype="multipart/form-data">
        <input type="file" name="csv_file" accept=".csv" required>
        <button type="submit">ä¸Šå‚³ CSV</button>
    </form>

    <hr>

    <h2>æ–°å¢èª²ç¨‹</h2>
    <form method="POST" action="/">
        <label>æ˜ŸæœŸï¼š</label><input type="text" name="day" required>
        <label>æ™‚é–“ï¼š</label><input type="text" name="time" required placeholder="ä¾‹å¦‚ 08:00-10:00">
        <label>ç§‘ç›®ï¼š</label><input type="text" name="subject" required>
        <label>åœ°é»ï¼š</label><input type="text" name="location">
        <label>è€å¸«ï¼š</label><input type="text" name="teacher">
        <button type="submit">æ–°å¢</button>
    </form>

    <hr>

    <h2>ğŸ—“ï¸ ä¸€é€±èª²è¡¨</h2>
    <table border="1" cellpadding="5">
        <tr>
            <th>æ™‚é–“</th>
            {% for day in days %}
                <th>æ˜ŸæœŸ{{ day }}</th>
            {% endfor %}
        </tr>
        {% for time in times %}
        <tr>
            <td>{{ time }}</td>
            {% for day in days %}
            <td data-day="{{ day }}" data-time="{{ schedule[time][day].time if schedule[time][day] else '' }}">
                {% if schedule[time][day] %}
                    <strong>{{ schedule[time][day].subject }}</strong><br>
                    {{ schedule[time][day].teacher }} @ {{ schedule[time][day].location }}<br>
                    {% if schedule[time][day].note %}
                        <em>ğŸ“Œ {{ schedule[time][day].note }}</em><br>
                    {% endif %}
                    <form method="POST" action="/delete/{{ schedule[time][day].id }}" style="margin-top:4px;">
                        <button type="submit">åˆªé™¤</button>
                    </form>
                    <form method="POST" action="/note/{{ schedule[time][day].id }}">
                        <input type="text" name="note" placeholder="æ–°å¢æˆ–ä¿®æ”¹å‚™è¨»" style="width: 90%;" required>
                        <button type="submit">ğŸ“ å‚™è¨»</button>
                    </form>
                {% endif %}
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </table>

    <script>
        function timeToMinutes(t) {
            const [h, m] = t.split(':').map(Number);
            return h * 60 + m;
        }

        function updateCurrentTime() {
            const now = new Date();
            const days = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
            const day = days[now.getDay()];
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            const timeString = `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            document.getElementById('current-time').textContent = `ç¾åœ¨æ™‚é–“ï¼šæ˜ŸæœŸ${day} ${timeString}`;

            const currentMinutes = hours * 60 + minutes;

            const cells = document.querySelectorAll('td[data-day][data-time]');
            cells.forEach(cell => {
                const cellDay = cell.getAttribute('data-day');
                const cellTime = cell.getAttribute('data-time');
                if (!cellTime) return;

                const timeRanges = cellTime.split(',');

                let highlight = false;
                for (const range of timeRanges) {
                    const [start, end] = range.trim().split('-');
                    if (!start || !end) continue;

                    const startMinutes = timeToMinutes(start);
                    const endMinutes = timeToMinutes(end);

                    if (cellDay === day && currentMinutes >= startMinutes && currentMinutes <= endMinutes) {
                        highlight = true;
                        break;
                    }
                }

                if (highlight) {
                    cell.classList.add('highlight');
                } else {
                    cell.classList.remove('highlight');
                }
            });
        }

        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
    </script>
</body>
</html>
